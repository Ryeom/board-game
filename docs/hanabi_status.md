# 하나비 구현 현황

## 구현된 기능

### 핵심 게임 로직 (`internal/game/hanabi`)
- **게임 상태 (`State` 구조체)**
    - `Fireworks`(색상별 진행도), `HintTokens`(8개), `MissTokens`(3개) 추적.
    - `Deck` 생성 및 셔플 관리.
    - `PlayerHands` 관리 (플레이어 수에 따라 4~5장 분배).
    - **시야 마스킹**: `GetPlayerView`는 힌트를 통해 명시적으로 "알려진" 경우가 아니면 플레이어 자신의 카드 정보(색상/숫자)를 올바르게 숨김.

- **게임 액션**
    - **`give_hint`**:
        - 색상 또는 숫자에 대한 힌트 제공 가능.
        - 힌트 토큰 1개 소모.
        - 대상 카드의 `ColorKnown` / `NumberKnown` 플래그 업데이트.
    - **`play_card`**:
        - 카드 인덱스 유효성 검사.
        - 카드가 현재 불꽃놀이 순서에 맞는지 확인.
        - **성공**: 불꽃놀이 점수 업데이트. '5'를 냈을 경우 힌트 토큰 1개 회복 (보너스 룰).
        - **실패**: 미스 토큰 1개 차감. 미스 토큰이 0 이하가 되면 `GameOver = true` 설정.
        - **드로우**: 덱에서 자동으로 새 카드를 가져옴.
    - **`discard`**:
        - 선택한 카드를 `DiscardPile`에 버림.
        - 힌트 토큰 1개 회복.
        - 새 카드를 드로우.
    - **`end_turn`**:
        - `TurnIndex` 진행.
        - 게임 종료를 위한 덱 소진 조건 확인 (마지막 라운드 로직).

### 서버 및 인프라
- **정의된 웹소켓 이벤트**: `game.start`, `game.action`, `game.end`.
- **구조**: 여러 게임을 지원하기 위한 `Engine` 인터페이스 정의.

## 📜 게임 규칙 적용 상태 체크리스트 (규칙 검증)

`docs/game_rule/hanabi.md` 기준 구현 여부 점검 결과.

### 구성물 및 준비
- [✅] **카드 구성**: 색상별 1(3), 2(2), 3(2), 4(2), 5(1) (`GenerateDeck`)
- [✅] **토큰 설정**: 힌트 8개, 오답 3개 (`NewState`)
- [✅] **카드 분배**: 인원수에 따른 4/5장 분배 (`DealInitialCards`)
- [✅] **정보 숨김**: 자신의 카드 내용 숨김 처리 (`GetPlayerView`)

### 행동 A. 정보(힌트) 주기
- [✅] **기본 기능**: 색상 또는 숫자로 힌트 제공 및 마킹
- [✅] **비용**: 힌트 토큰 1개 소모
- [❌] **유효성 검사**: 손에 없는 정보(0장의 카드)에 대한 힌트 금지 **(미구현: 0장이어도 토큰 소모됨)**

### 행동 B. 카드 내려놓기 (등록)
- [✅] **성공/실패 판정**: 올바른 순서면 성공, 아니면 실패
- [✅] **보너스**: 숫자 '5' 완성 시 힌트 토큰 +1
- [✅] **실패 페널티**: 오답 토큰 추가 및 미스 토큰 감소

### 행동 C. 카드 버리기
- [✅] **기본 기능**: 카드 버리기 및 드로우
- [❌] **조건 제약**: 힌트 토큰이 꽉 찼을(8개) 경우 버리기 행동 불가 **(미구현: 8개여도 버리기 가능, 토큰만 안 참)**

### 게임 종료 및 승패
- [❌] **승리 조건**: 25점 완성 시 즉시 종료 **(미구현)**
- [✅] **패배 조건**: 오답 토큰 3개 누적 시 즉시 패배 (`IsGameOver` 체크)
- [✅] **덱 소진 종료**: 덱 소진 후 마지막 턴 진행 로직 (`handleEndTurn`)


## 누락 / 미완성 사항

### 1. 서버 연결 (중요)
- **`server/ws/events_game.go`**: `hanabi.NewEngine` 초기화 코드가 **주석 처리**되어 있음.
    - *원인*: `BroadcastFunc` 또는 `State` 저장/로드 콜백의 리팩토링 때문으로 추정.
    - *영향*: 현재 API를 통해 하나비 게임을 시작할 수 없음.

### 2. 게임 규칙
- **승리 조건**: 현재 25점 만점을 달성해도 게임이 즉시 종료되지 않음. 덱이 소진될 때까지 계속됨.
- **점수 계산**: `GetCurrentScore`가 존재하지만 게임 종료 시 "최종 점수" 이벤트로 자동 브로드캐스트되지 않음.

### 3. 잠재적 문제
- **동시성**: `HandleGameEnd`에서 `DeleteGameState`와 `SaveGameState`의 사용을 주의 깊게 관리해야 함.
- **유효성 검사**:
    - `give_hint`: 힌트가 실제로 최소 한 장의 카드에 적용되는지 엄격하게 검사하지 않음 (표준 하나비 규칙: 0장의 카드에 닿는 힌트는 줄 수 없음). *분석: 코드는 카드를 순회하며 플래그를 설정함. 일치하는 카드가 없으면 효과 없이 토큰만 소모함. 엄격한 규칙 적용 필요.*


## 상세 로드맵 (구현 작업 목록)

| ID | 작업 분류 | 상세 내용 | 상태 | 작업 날짜 |
| :--- | :--- | :--- | :--- | :--- |
| **TASK-001** | **서버 와이어링** | `events_game.go`에서 `HandleGameStart` 내 `hanabi.NewEngine` 초기화 코드 주석 해제 | [✅] | 2026-01-14 |
| **TASK-002** | **서버 와이어링** | `BroadcastFunc`에서 `state`를 `*hanabi.State`로 캐스팅하는 로직 검증 및 `NewEngine` 호출 시그니처 일치 확인 | [✅] | 2026-01-14 |
| **TASK-003** | **서버 와이어링** | `setGameStateFunc`, `getGameStateFunc` 콜백 함수가 `game.SaveGameState`, `game.GetGameState`와 올바르게 매핑되는지 확인 | [✅] | 2026-01-14 |
| **TASK-101** | **리팩토링** | `activeGameEngines`를 관리하는 `GameManager` 구조체 추출 (전역 상태 제거) | [✅] | 2026-01-14 |
| **TASK-102** | **리팩토링** | 웹소켓 핸들러와 게임 로직 분리 (Service 레이어 도입) | [✅] | 2026-01-15 |
| **TASK-103** | **리팩토링** | `events_game.go` 내 불필요한 주석 및 미사용 코드(TilePush 등) 정리 | [✅] | 2026-01-15 |
| **TASK-104** | **리팩토링** | `events_room.go`에서 방 관리 로직 분리 (`RoomService` 도입) | [✅] | 2026-01-15 |
| **TASK-004** | **게임 로직 개선** | **즉시 승리 구현**: `handlePlayCard`에서 불꽃놀이 점수 합계 25점 도달 시 `GameOver = true` 설정 | [✅] | 2026-01-15 |
| **TASK-005** | **게임 로직 개선** | **최종 점수 전송**: `game.end` 이벤트 브로드캐스트 시 `finalScore` 및 `victory` (승리 여부) 필드 포함 | [ ] | |
| **TASK-006** | **규칙 검증 강화** | **빈 힌트 방지**: `handleGiveHint`에서 대상 카드가 0장일 경우 에러 반환 (토큰 소모 방지) | [ ] | |
| **TASK-007** | **규칙 검증 강화** | **힌트 토큰 제한**: 힌트 토큰이 0개일 때 힌트 액션 시 명확한 에러 반환 | [ ] | |
| **TASK-008** | **규칙 검증 강화** | **버리기 제약**: 힌트 토큰이 8개일 때 버리기 액션 시도 시 에러 반환 | [ ] | |
| **TASK-009** | **테스트** | 주요 게임 시나리오(시작->힌트->플레이->종료)에 대한 통합 테스트(Go Test) 작성 | [ ] | |
| **TASK-010** | **확장 기능** | 가상 플레이어(AI) 연동 설계 (보류) | [ ] | |

